<!DOCTYPE html>
<html>
<head>
    <title>花草识别系统-Vue版</title>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
</head>
<body>
    <div id="app">
        <input type="file" @change="handleUpload" accept="image/*">
        <img :src="previewImage" v-if="previewImage" style="max-width: 300px;">
        <div>
            <button @click="analyzeImage">识别植物</button>
            <button @click="uploadToAliyun">上传至阿里云</button>
        </div>
        <div v-if="result">
            <h3>识别结果：{{ result.result[0].name }}</h3>
            <p>置信度：{{ (result.result[0].score * 100).toFixed(2) }}%</p>
        </div>
    </div>
    
<script>
new Vue({
    el: '#app',
    data: {
        previewImage: null,
        selectedFile: null,
        result: null
    },
    methods: {
        handleUpload(e) {
            const file = e.target.files[0];
            if (file) {
                this.previewImage = URL.createObjectURL(file);
                this.selectedFile = file;
            }
        },
        getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        },
        async analyzeImage() {
            if (!this.selectedFile) return alert('请先选择图片');
            
            try {
                const base64Data = await this.getBase64(this.selectedFile);
                const response = await fetch('http://localhost:3000/api/plant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Data })
                });
                
                if (!response.ok) throw new Error('识别请求失败');
                this.result = await response.json();
            } catch (error) {
                console.error('识别失败:', error);
                alert(`识别失败：${error.message}`);
            }
        },
        async uploadToAliyun() {
            if (!this.selectedFile) return alert('请先选择图片');
            
            try {
                const formData = new FormData();
                formData.append('file', this.selectedFile);

                const response = await fetch('http://localhost:3000/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '上传失败');
                
                alert(`上传成功！\n文件名：${result.name}\n文件地址：${result.url}`);
            } catch (error) {
                console.error('上传失败:', error);
                alert(`上传失败：${error.message}`);
            }
        }
    }
})
</script>
</body>
</html>